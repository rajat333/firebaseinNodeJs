<!DOCTYPE html>
<html>
<head>
  <title>async.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../doc-style.css" />
  <script src="../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../";
    var thisFile = "node-refresh-token\\node_modules\\ajv\\lib\\async.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>async.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">'use strict'</span>;

<span class="hljs-built_in">module</span>.exports = {
  <span class="hljs-attr">setup</span>: setupAsync,
  <span class="hljs-attr">compile</span>: compileAsync
};


<span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./compile/util'</span>);

<span class="hljs-keyword">var</span> ASYNC = {
  <span class="hljs-string">'*'</span>: checkGenerators,
  <span class="hljs-string">'co*'</span>: checkGenerators,
  <span class="hljs-string">'es7'</span>: checkAsyncFunction
};

<span class="hljs-keyword">var</span> TRANSPILE = {
  <span class="hljs-string">'nodent'</span>: getNodent,
  <span class="hljs-string">'regenerator'</span>: getRegenerator
};

<span class="hljs-keyword">var</span> MODES = [
  { <span class="hljs-attr">async</span>: <span class="hljs-string">'co*'</span> },
  { <span class="hljs-attr">async</span>: <span class="hljs-string">'es7'</span>, <span class="hljs-attr">transpile</span>: <span class="hljs-string">'nodent'</span> },
  { <span class="hljs-attr">async</span>: <span class="hljs-string">'co*'</span>, <span class="hljs-attr">transpile</span>: <span class="hljs-string">'regenerator'</span> }
];


<span class="hljs-keyword">var</span> regenerator, nodent;


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setupAsync</span>(<span class="hljs-params">opts, required</span>) </span>{
  <span class="hljs-keyword">if</span> (required !== <span class="hljs-literal">false</span>) required = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">var</span> <span class="hljs-keyword">async</span> = opts.async
    , transpile = opts.transpile
    , check;

  <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">typeof</span> transpile) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'string'</span>:
      <span class="hljs-keyword">var</span> get = TRANSPILE[transpile];
      <span class="hljs-keyword">if</span> (!get) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'bad transpiler: '</span> + transpile);
      <span class="hljs-keyword">return</span> (opts._transpileFunc = get(opts, required));
    <span class="hljs-keyword">case</span> <span class="hljs-string">'undefined'</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">'boolean'</span>:
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">async</span> == <span class="hljs-string">'string'</span>) {
        check = ASYNC[<span class="hljs-keyword">async</span>];
        <span class="hljs-keyword">if</span> (!check) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'bad async mode: '</span> + <span class="hljs-keyword">async</span>);
        <span class="hljs-keyword">return</span> (opts.transpile = check(opts, required));
      }

      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i&lt;MODES.length; i++) {
        <span class="hljs-keyword">var</span> _opts = MODES[i];
        <span class="hljs-keyword">if</span> (setupAsync(_opts, <span class="hljs-literal">false</span>)) {
          util.copy(_opts, opts);
          <span class="hljs-keyword">return</span> opts.transpile;
        }
      }
      <span class="hljs-comment">/* istanbul ignore next */</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'generators, nodent and regenerator are not available'</span>);
    <span class="hljs-keyword">case</span> <span class="hljs-string">'function'</span>:
      <span class="hljs-keyword">return</span> (opts._transpileFunc = opts.transpile);
    <span class="hljs-keyword">default</span>:
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'bad transpiler: '</span> + transpile);
  }
}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkGenerators</span>(<span class="hljs-params">opts, required</span>) </span>{
  <span class="hljs-comment">/* jshint evil: true */</span>
  <span class="hljs-keyword">try</span> {
    (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Function</span>(<span class="hljs-string">'(function*(){})()'</span>))();
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  } <span class="hljs-keyword">catch</span>(e) {
    <span class="hljs-comment">/* istanbul ignore next */</span>
    <span class="hljs-keyword">if</span> (required) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'generators not supported'</span>);
  }
}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkAsyncFunction</span>(<span class="hljs-params">opts, required</span>) </span>{
  <span class="hljs-comment">/* jshint evil: true */</span>
  <span class="hljs-keyword">try</span> {
    (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Function</span>(<span class="hljs-string">'(async function(){})()'</span>))();
    <span class="hljs-comment">/* istanbul ignore next */</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  } <span class="hljs-keyword">catch</span>(e) {
    <span class="hljs-keyword">if</span> (required) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'es7 async functions not supported'</span>);
  }
}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getRegenerator</span>(<span class="hljs-params">opts, required</span>) </span>{
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">if</span> (!regenerator) {
      <span class="hljs-keyword">var</span> name = <span class="hljs-string">'regenerator'</span>;
      regenerator = <span class="hljs-built_in">require</span>(name);
      regenerator.runtime();
    }
    <span class="hljs-keyword">if</span> (!opts.async || opts.async === <span class="hljs-literal">true</span>)
      opts.async = <span class="hljs-string">'es7'</span>;
    <span class="hljs-keyword">return</span> regeneratorTranspile;
  } <span class="hljs-keyword">catch</span>(e) {
    <span class="hljs-comment">/* istanbul ignore next */</span>
    <span class="hljs-keyword">if</span> (required) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'regenerator not available'</span>);
  }
}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">regeneratorTranspile</span>(<span class="hljs-params">code</span>) </span>{
  <span class="hljs-keyword">return</span> regenerator.compile(code).code;
}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getNodent</span>(<span class="hljs-params">opts, required</span>) </span>{
  <span class="hljs-comment">/* jshint evil: true */</span>
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">if</span> (!nodent) {
      <span class="hljs-keyword">var</span> name = <span class="hljs-string">'nodent'</span>;
      nodent = <span class="hljs-built_in">require</span>(name)({ <span class="hljs-attr">log</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">dontInstallRequireHook</span>: <span class="hljs-literal">true</span> });
    }
    <span class="hljs-keyword">if</span> (opts.async != <span class="hljs-string">'es7'</span>) {
      <span class="hljs-keyword">if</span> (opts.async &amp;&amp; opts.async !== <span class="hljs-literal">true</span>) <span class="hljs-built_in">console</span>.warn(<span class="hljs-string">'nodent transpiles only es7 async functions'</span>);
      opts.async = <span class="hljs-string">'es7'</span>;
    }
    <span class="hljs-keyword">return</span> nodentTranspile;
  } <span class="hljs-keyword">catch</span>(e) {
    <span class="hljs-comment">/* istanbul ignore next */</span>
    <span class="hljs-keyword">if</span> (required) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'nodent not available'</span>);
  }
}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">nodentTranspile</span>(<span class="hljs-params">code</span>) </span>{
  <span class="hljs-keyword">return</span> nodent.compile(code, <span class="hljs-string">''</span>, { <span class="hljs-attr">promises</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">sourcemap</span>: <span class="hljs-literal">false</span> }).code;
}


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<div class="dox">
<div class="summary">
<p>Creates validating function for passed schema with asynchronous loading of missing schemas.
<code>loadSchema</code> option should be a function that accepts schema uri and node-style callback.</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">schema</span>
<span class="dox_type">Object</span>
<span>schema object
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">callback</span>
<span class="dox_type">Function</span>
<span>node-style callback, it is always called with 2 parameters: error (or null) and validating function.
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">compileAsync</span>(<span class="hljs-params">schema, callback</span>) </span>{
  <span class="hljs-comment">/* eslint no-shadow: 0 */</span>
  <span class="hljs-comment">/* jshint validthis: true */</span>
  <span class="hljs-keyword">var</span> schemaObj;
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">try</span> {
    schemaObj = <span class="hljs-keyword">this</span>._addSchema(schema);
  } <span class="hljs-keyword">catch</span>(e) {
    setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ callback(e); });
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-keyword">if</span> (schemaObj.validate) {
    setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ callback(<span class="hljs-literal">null</span>, schemaObj.validate); });
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">this</span>._opts.loadSchema != <span class="hljs-string">'function'</span>)
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'options.loadSchema should be a function'</span>);
    _compileAsync(schema, callback, <span class="hljs-literal">true</span>);
  }


  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_compileAsync</span>(<span class="hljs-params">schema, callback, firstCall</span>) </span>{
    <span class="hljs-keyword">var</span> validate;
    <span class="hljs-keyword">try</span> { validate = self.compile(schema); }
    <span class="hljs-keyword">catch</span>(e) {
      <span class="hljs-keyword">if</span> (e.missingSchema) loadMissingSchema(e);
      <span class="hljs-keyword">else</span> deferCallback(e);
      <span class="hljs-keyword">return</span>;
    }
    deferCallback(<span class="hljs-literal">null</span>, validate);

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadMissingSchema</span>(<span class="hljs-params">e</span>) </span>{
      <span class="hljs-keyword">var</span> ref = e.missingSchema;
      <span class="hljs-keyword">if</span> (self._refs[ref] || self._schemas[ref])
        <span class="hljs-keyword">return</span> callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Schema '</span> + ref + <span class="hljs-string">' is loaded but '</span> + e.missingRef + <span class="hljs-string">' cannot be resolved'</span>));
      <span class="hljs-keyword">var</span> _callbacks = self._loadingSchemas[ref];
      <span class="hljs-keyword">if</span> (_callbacks) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> _callbacks == <span class="hljs-string">'function'</span>)
          self._loadingSchemas[ref] = [_callbacks, schemaLoaded];
        <span class="hljs-keyword">else</span>
          _callbacks[_callbacks.length] = schemaLoaded;
      } <span class="hljs-keyword">else</span> {
        self._loadingSchemas[ref] = schemaLoaded;
        self._opts.loadSchema(ref, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, sch</span>) </span>{
          <span class="hljs-keyword">var</span> _callbacks = self._loadingSchemas[ref];
          <span class="hljs-keyword">delete</span> self._loadingSchemas[ref];
          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> _callbacks == <span class="hljs-string">'function'</span>) {
            _callbacks(err, sch);
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i&lt;_callbacks.length; i++)
              _callbacks[i](err, sch);
          }
        });
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">schemaLoaded</span>(<span class="hljs-params">err, sch</span>) </span>{
        <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> callback(err);
        <span class="hljs-keyword">if</span> (!(self._refs[ref] || self._schemas[ref])) {
          <span class="hljs-keyword">try</span> {
            self.addSchema(sch, ref);
          } <span class="hljs-keyword">catch</span>(e) {
            callback(e);
            <span class="hljs-keyword">return</span>;
          }
        }
        _compileAsync(schema, callback);
      }
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">deferCallback</span>(<span class="hljs-params">err, validate</span>) </span>{
      <span class="hljs-keyword">if</span> (firstCall) setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ callback(err, validate); });
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> callback(err, validate);
    }
  }
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
