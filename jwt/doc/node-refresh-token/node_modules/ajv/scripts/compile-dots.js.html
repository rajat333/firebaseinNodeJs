<!DOCTYPE html>
<html>
<head>
  <title>compile-dots.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../doc-style.css" />
  <script src="../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../";
    var thisFile = "node-refresh-token\\node_modules\\ajv\\scripts\\compile-dots.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>compile-dots.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>
<p>compile doT templates to js functions</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">'use strict'</span>;

<span class="hljs-keyword">var</span> glob = <span class="hljs-built_in">require</span>(<span class="hljs-string">'glob'</span>)
  , fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>)
  , path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)
  , doT = <span class="hljs-built_in">require</span>(<span class="hljs-string">'dot'</span>)
  , beautify = <span class="hljs-built_in">require</span>(<span class="hljs-string">'js-beautify'</span>).js_beautify;

<span class="hljs-keyword">var</span> defsRootPath = process.argv[<span class="hljs-number">2</span>] || path.join(__dirname, <span class="hljs-string">'../lib'</span>);

<span class="hljs-keyword">var</span> defs = {};
<span class="hljs-keyword">var</span> defFiles = glob.sync(<span class="hljs-string">'./dot/**/*.def'</span>, { <span class="hljs-attr">cwd</span>: defsRootPath });
defFiles.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">f</span>) </span>{
  <span class="hljs-keyword">var</span> name = path.basename(f, <span class="hljs-string">'.def'</span>);
  defs[name] = fs.readFileSync(path.join(defsRootPath, f));
});

<span class="hljs-keyword">var</span> filesRootPath = process.argv[<span class="hljs-number">3</span>] || path.join(__dirname, <span class="hljs-string">'../lib'</span>);
<span class="hljs-keyword">var</span> files = glob.sync(<span class="hljs-string">'./dot/**/*.jst'</span>, { <span class="hljs-attr">cwd</span>: filesRootPath });

<span class="hljs-keyword">var</span> dotjsPath = path.join(filesRootPath, <span class="hljs-string">'./dotjs'</span>);
<span class="hljs-keyword">try</span> { fs.mkdirSync(dotjsPath); } <span class="hljs-keyword">catch</span>(e) {}

<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'\n\nCompiling:'</span>);

<span class="hljs-keyword">var</span> FUNCTION_NAME = <span class="hljs-regexp">/function\s+anonymous\s*\(it[^)]*\)\s*{/</span>;
<span class="hljs-keyword">var</span> OUT_EMPTY_STRING = <span class="hljs-regexp">/out\s*\+=\s*'\s*';/g</span>;
<span class="hljs-keyword">var</span> ISTANBUL = <span class="hljs-regexp">/\'(istanbul[^']+)\';/g</span>;
<span class="hljs-keyword">var</span> ERROR_KEYWORD = <span class="hljs-regexp">/\$errorKeyword/g</span>;
<span class="hljs-keyword">var</span> ERROR_KEYWORD_OR = <span class="hljs-regexp">/\$errorKeyword\s+\|\|/g</span>;
<span class="hljs-keyword">var</span> VARS = [
  <span class="hljs-string">'$errs'</span>, <span class="hljs-string">'$valid'</span>, <span class="hljs-string">'$lvl'</span>, <span class="hljs-string">'$data'</span>, <span class="hljs-string">'$dataLvl'</span>,
  <span class="hljs-string">'$errorKeyword'</span>, <span class="hljs-string">'$closingBraces'</span>, <span class="hljs-string">'$schemaPath'</span>,
  <span class="hljs-string">'$validate'</span>
];

files.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">f</span>) </span>{
  <span class="hljs-keyword">var</span> keyword = path.basename(f, <span class="hljs-string">'.jst'</span>);
  <span class="hljs-keyword">var</span> targetPath = path.join(dotjsPath, keyword + <span class="hljs-string">'.js'</span>);
  <span class="hljs-keyword">var</span> template = fs.readFileSync(path.join(filesRootPath, f));
  <span class="hljs-keyword">var</span> code = doT.compile(template, defs);
  code = code.toString()
             .replace(OUT_EMPTY_STRING, <span class="hljs-string">''</span>)
             .replace(FUNCTION_NAME, <span class="hljs-string">'function generate_'</span> + keyword + <span class="hljs-string">'(it, $keyword) {'</span>)
             .replace(ISTANBUL, <span class="hljs-string">'/* $1 */'</span>);
  removeAlwaysFalsyInOr();
  VARS.forEach(removeUnusedVar);
  code = <span class="hljs-string">"'use strict';\nmodule.exports = "</span> + code;
  code = beautify(code, { <span class="hljs-attr">indent_size</span>: <span class="hljs-number">2</span> }) + <span class="hljs-string">'\n'</span>;
  fs.writeFileSync(targetPath, code);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'compiled'</span>, keyword);

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">removeUnusedVar</span>(<span class="hljs-params">v</span>) </span>{
    v = v.replace(<span class="hljs-regexp">/\$/g</span>, <span class="hljs-string">'\\$$'</span>);
    <span class="hljs-keyword">var</span> regexp = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(v + <span class="hljs-string">'[^A-Za-z0-9_$]'</span>, <span class="hljs-string">'g'</span>);
    <span class="hljs-keyword">var</span> count = occurrences(regexp);
    <span class="hljs-keyword">if</span> (count == <span class="hljs-number">1</span>) {
      regexp = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">'var\\s+'</span> + v + <span class="hljs-string">'\\s*=[^;]+;|var\\s+'</span> + v + <span class="hljs-string">';'</span>);
      code = code.replace(regexp, <span class="hljs-string">''</span>);
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">removeAlwaysFalsyInOr</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> countUsed = occurrences(ERROR_KEYWORD);
    <span class="hljs-keyword">var</span> countOr = occurrences(ERROR_KEYWORD_OR);
    <span class="hljs-keyword">if</span> (countUsed == countOr + <span class="hljs-number">1</span>) code = code.replace(ERROR_KEYWORD_OR, <span class="hljs-string">''</span>);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">occurrences</span>(<span class="hljs-params">regexp</span>) </span>{
    <span class="hljs-keyword">return</span> (code.match(regexp) || []).length;
  }
});

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
